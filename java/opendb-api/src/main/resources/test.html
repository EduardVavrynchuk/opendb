<!DOCTYPE html>
<html>
 <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>

<head>
</head>

<body>
<h1>Test harness for OpenDB</h1>
<h3>Operations in Queue</h3>
<ul id="operations-list">
</ul>


<p id="result"></p>

<input type="submit" value="Clear queue" id="clear-list" />

<h3>Bootstrap</h3>
<div>
Server username: <input type="text" id="boot-server-name"/>  
Server private key: <input type="text" id="boot-server-pk"/>  
<br>
<input type="submit" value="Bootstrap" id="boot-btn"/>
</div>

<!-- 
-->
<h3>Signup</h3>
<div>
Nickname: <input type="text" id="signup-name"/> 
<br>
Password: <input type="text" id="signup-pwd"/> 
<br>
OAuth provider: <input type="text" id="signup-oauth-p"/>  
OAuth Id: <input type="text" id="signup-oauth-id"/> 
<br>
Server username: <input type="text" id="signup-server-name"/>  
Server private key: <input type="text" id="signup-server-pk"/>  
<br>
User details (raw json): <input type="text" id="signup-details"/>  
<br>
<input type="submit" value="Signup" id="signup-btn"/>
</div>

<h3>Login</h3>
<div>
Nickname: <input type="text" id="login-name"/> 
<br>
Password: <input type="text" id="login-pwd"/> 
<br>
OAuth provider: <input type="text" id="login-oauth-p"/>  
OAuth Id: <input type="text" id="login-oauth-id"/> 
<br>
Server username: <input type="text" id="login-server-name"/>  
Server private key: <input type="text" id="login-server-pk"/>  
<br>
<input type="submit" value="Login" id="login-btn"/>
</div>


</body>
<script>


function loadData() {
	$.getJSON( "/queue/list", function( data ) {
  		var items = "";
  		for(var i = 0; i < data.operations.length; i++)  {
  			let op = data.operations[i];
  			let clone = JSON.parse(JSON.stringify(op));
  			delete clone.hash;
  			delete clone.signature;
        delete clone.signature_hash;
        delete clone.validation;
  			sha256(JSON.stringify(clone)).then(digestValue => {
  				if(("json:sha256:" + digestValue) != op.hash) {
  					alert("Warning! Hash of tx '" + op.hash + "' is not correct - 'json:sha256:" + digestValue +"'");
  				}
			});
  			items += "<br><li><b>Hash</b>: " + op.hash;
  			items += "<br><b>Operation</b>: " + op.operation;
        items += "<br><b>Name</b>: " + op.name;
  			items += "<br><b>Signed by</b>: " + op.signed_by;
  			items += "<br><b>Details</b>: " + JSON.stringify(op);
  			items += "<br></li>";
  		}
 		$("#operations-list").html(items);
  		
});
}

$( document ).ready(function() {
    loadData();
    $("#clear-list").click(function(){
      $.post("/queue/clear", {},  function(data, status){
        loadData();
      });
    });

    $("#boot-btn").click(function(){
      var obj = {
        "privateKey":$("#boot-server-pk").val(),
        "serverName":$("#boot-server-name").val()
      };
      $.post("/block/bootstrap", obj)
        .done(function(data){  $("#result").html(data); loadData(); })
        .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); });
    });

    $("#signup-btn").click(function() {
      var obj = {
        "pwd":$("#signup-pwd").val(),
        "name":$("#signup-name").val(),
        "oauthProvider":$("#signup-oauth-p").val(),
        "oauthId":$("#signup-oauth-id").val(),
        "privateKey":$("#signup-server-pk").val(),
        "serverName":$("#signup-server-name").val(),
        "userDetails":$("#signup-details").val()
      };
      $.post("/op/signup", obj)
          .done(function(data){  $("#result").html(data); loadData(); })
          .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); });
    });

    $("#login-btn").click(function() {
    	var obj = {
    		"pwd":$("#login-pwd").val(),
    		"name":$("#login-name").val(),
        "oauthProvider":$("#login-oauth-p").val(),
        "oauthId":$("#login-oauth-id").val(),
        "privateKey":$("#login-server-pk").val(),
        "serverName":$("#login-server-name").val()
    	};
    	$.post("/op/login", obj)
          .done(function(data){  $("#result").html(data); loadData();})
          .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); });
    });
});

async function sha256(message) {
    // encode as UTF-8
    const msgBuffer = new TextEncoder('utf-8').encode(message);                    

    // hash the message
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);

    // convert ArrayBuffer to Array
    const hashArray = Array.from(new Uint8Array(hashBuffer));

    // convert bytes to hex string                  
    const hashHex = hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
    return hashHex;
}
</script>

</html>